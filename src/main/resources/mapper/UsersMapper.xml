<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kevin.intellieventback.mapper.UsersMapper">

    <select id="selectUserPageWithOrg" resultType="com.kevin.intellieventback.domin.entity.Users">
        SELECT
            u.*,
            uo.organization_id as organizationId,
            o.name as organizationName,
            roleAgg.roleNames as roleNames
        FROM users u
        LEFT JOIN user_organization uo ON u.id COLLATE utf8mb4_general_ci = uo.user_id COLLATE utf8mb4_general_ci AND uo.is_primary = 1
        LEFT JOIN organizations o ON o.id COLLATE utf8mb4_general_ci = uo.organization_id COLLATE utf8mb4_general_ci
        LEFT JOIN (
            SELECT ur.user_id,
                   GROUP_CONCAT(DISTINCT r.name ORDER BY r.sort SEPARATOR '„ÄÅ') AS roleNames
            FROM sys_user_role ur
            LEFT JOIN sys_role r ON r.id COLLATE utf8mb4_general_ci = ur.role_id COLLATE utf8mb4_general_ci
            GROUP BY ur.user_id
        ) roleAgg ON roleAgg.user_id COLLATE utf8mb4_general_ci = u.id COLLATE utf8mb4_general_ci
        <where>
            <if test="user.userName != null and user.userName != ''">
                AND u.user_name LIKE CONCAT('%', #{user.userName}, '%')
            </if>
            <if test="user.realName != null and user.realName != ''">
                AND u.real_name LIKE CONCAT('%', #{user.realName}, '%')
            </if>
            <if test="user.email != null and user.email != ''">
                AND u.email LIKE CONCAT('%', #{user.email}, '%')
            </if>
            <if test="user.phone != null and user.phone != ''">
                AND u.phone LIKE CONCAT('%', #{user.phone}, '%')
            </if>
            <if test="user.status != null">
                AND u.status = #{user.status}
            </if>
            <if test="user.organizationId != null and user.organizationId != ''">
                AND EXISTS (SELECT 1 FROM user_organization uo_filter WHERE uo_filter.user_id = u.id AND uo_filter.organization_id = #{user.organizationId})
            </if>
        </where>
        ORDER BY u.created_at DESC
    </select>

</mapper>
